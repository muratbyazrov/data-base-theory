## DML: агрегация и сортировка, CTE, аналитические функции

[К оглавлению...](/README.md)

### GROUP

- группировка - это схлопывание
  - если какие-то поля не могут быть объединены - группировки не будет

- группировка по одному полю + показать количество сгруппированных записей

```sql
SELECT staff, count(*)
FROM rent
GROUP BY staff
```

- группировка + показать итог

```sql
SELECT staff, count(*)
FROM rent
GROUP BY ROLLUP staff
```

- группировка по двум полям + показать количество сгруппированных

```sql
SELECT staff, customer, count(*)
FROM rent
GROUP BY staff
```

- 1-ый и 2-ой запросы выше одним запросом

```sql
SELECT staff, customer, count(*)
FROM rent
GROUPING SETS (staff, (staff, customer))
```

- группировка с условием

```sql
-- покажет уникальные staff и их количество, причем только те, у которых кол-во > 1

SELECT staff count(*)
FROM rent
GROUP BY staff
HAVING count(*) > 1
```

- `union` - объединение выборок (но схлопнет одинаковые выводы)
- `union all` - объединения выборок (покажет все как есть)

- есть ещё group by cube - все перекрестные вычисления (хз, надо смотреть че это)

### CTE (common table expression)

- по-русски: Обобщенные табличные выражения
- это запросы с `with`
  - материализовался до 12 версии
  - есть рекурсии

- `OFFSET` - ресурсоемкий
  - Можно идти с конца, если необходимый кусок внизу

### Оконные функции

- предоставляют возможность вычислять значения, выполнять агрегатные или аналитические функции в пределах некоторой
  группы строк в запросе (окна)

- Примеры оконных функций в PostgreSQL
  - `ROW_NUMBER` - Присваивает уникальный номер каждой строке в результате запроса
  - `RANK`
  - `DENSE_RANK`
  - `LAG` - Возвращает значение из предыдущей строки в указанной колонке
  - `LEAD` - Возвращает значение из следующей строки в указанной колонке
  - `SUM` - Вычисляет сумму значений в указанной колонке
  - `AVG` - Вычисляет среднее значение в указанной колонке
  - `COUNT` - Подсчитывает количество строк в результате запроса или количество непустых значений в указанной колонке
  - есть и другие

- можно создавать свои оконные функции (CREATE WINDOW FUNCTION)
- Оконные функции обычно применяются вместе с ключевым словом OVER, которое указывает на определенное окно или набор
  строк, над которыми должна быть выполнена функция.

```sql
-- Этот запрос пронумерует строки в таблице employees в порядке убывания зарплаты и вернет столбцы name, salary и rank.

SELECT name, salary, ROW_NUMBER() OVER (ORDER BY salary DESC) as rank
FROM employees;
```

- `RANK` и `DENSE_RANK` - это ранжирование
  - PostgreSQL сначала упорядочивает строки в результате запроса на основе указанного порядка сортировки
  - Затем каждой строке присваивается ранг, который обозначает ее позицию в упорядоченном списке
- Например, если у вас есть таблица с оценками студентов, функция RANK может присвоить ранг каждой оценке
- если две строки имеют одинаковые значения и должны получить одинаковый ранг, следующая строка получит ранг,
  увеличенный на количество пропущенных значений
- `DENSE_RANK` отличается только тем, что следующая строчка получит ранг увеличенный не на количество пропущенных
  значений, а на 1 (то есть последовательно)

```sql
SELECT name, score, RANK() OVER (ORDER BY score DESC) AS rank
FROM students;
```
