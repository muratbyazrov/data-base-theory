## Архитектура Postgres

[К оглавлению...](/README.md)

PostgreSQL (часто называемый "Postgres") - это мощная реляционная СУБД, которая имеет открытый исходный код и широко
используется в различных приложениях, включая крупные веб-приложения и корпоративные системы управления данными.
PostgreSQL был создан на базе языка программирования Си и имеет модульную архитектуру, которая позволяет расширять
функциональность системы через дополнительные модули.

<img src='./images/22.png' width=800 height=750>

Архитектура PostgreSQL разделяет функциональность СУБД на три основных компонента:

- **Query processor**
- **Utility processes**
- **Storage manager**

### Query processor

- **Process manager** - управляет запросами, поступающими от клиентов, и запускает необходимые процессы для выполнения
  запроса
- **Parser** - преобразует запрос, написанный на языке SQL, во внутреннее представление, понятное PostgreSQL
- **Rewriter** - оптимизирует запрос и заменяет некоторые части запроса на более эффективные альтернативы
- **Planner** - определяет наилучший план выполнения запроса, используя статистическую информацию о данных в таблицах
- **Executor** - выполняет запрос, используя план, выбранный планировщиком

### Utility processes

- **Writer** - записывает изменения в таблицы на диск
- **WAL Writer** - записывает информацию о транзакциях в WAL (Write Ahead Log) файлы на диск, что позволяет восстановить
  базу данных в случае сбоя
- **Check-pointer** - удаляет устаревшие данные из файлов WAL, что позволяет уменьшить размер WAL файлов и сократить
  время восстановления базы данных
- **Archiver Process** - архивирует WAL файлы для использования при восстановлении базы данных в случае сбоя
- **Logging collector** - собирает и хранит информацию о работе PostgreSQL для анализа и отладки.
- **Stats collector** - собирает статистику о запросах и использовании системных ресурсов, которая может быть
  использована для оптимизации запросов и настройки сервера
- **Vacuum** - выполняет очистку таблиц от удаленных строк, что позволяет уменьшить размер таблиц и ускорить запросы

### Storage manager

- **Data files** - файлы данных, в которых хранятся таблицы и индексы.
- **WAL files** - файлы, в которых записываются все изменения в базе данных.
- **Log files** - файлы журналов, в которых хранятся сообщения об ошибках и другие системные сообщения.
- **Archive files** - файлы архива, которые содержат резервные копии базы данных.

Каждый компонент storage manager отвечает за хранение определенного типа данных. `Data files` хранят таблицы и индексы,
`WAL files` хранят информацию о транзакциях, Log files хранят сообщения об ошибках и другие системные сообщения,
а `Archive files` содержат резервные копии базы данных

В PostgreSQL, таблицы и индексы хранятся в отдельных файлах в специально организованной файловой системе, называемой "
шарнуемой буферной кэш-памятью" (`shared buffer pool`). Когда данные запрашиваются из таблицы или индекса, они
загружаются в буферную кэш-память, чтобы ускорить доступ к данным в будущем. Если данные не помещаются в буферную
кэш-память, они извлекаются непосредственно из файла данных на диске.

`WAL files` являются ключевым компонентом для обеспечения надежности и целостности базы данных в PostgreSQL. Когда
транзакция записывается в базу данных, изменения записываются сначала в `WAL files`, а затем в файлы данных. Это
позволяет восстановить базу данных в случае сбоя, используя информацию из `WAL files`.

`Log files` содержат сообщения об ошибках и другие системные сообщения, которые могут быть полезны для отладки и анализа
работы PostgreSQL. Лог-файлы могут быть настроены для записи различных уровней сообщений, включая сообщения отладки,
информационные сообщения, предупреждения и сообщения об ошибках.

`Archive files` содержат резервные копии базы данных, которые могут быть использованы для восстановления базы данных в
случае сбоя или других проблем. Резервные копии могут быть созданы вручную или автоматически с помощью планировщика
заданий.

В целом, архитектура PostgreSQL очень гибкая и позволяет настраивать систему в соответствии с требованиями приложения.
PostgreSQL имеет широкие возможности для настройки и оптимизации производительности, что позволяет использовать систему
в самых разных сценариях.
