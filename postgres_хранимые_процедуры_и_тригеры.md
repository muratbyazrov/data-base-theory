## Хранимые процедуры и Тригеры

[К оглавлению...](/README.md)

Плюсы хранимых процедур (по сути бизнес логики в базе)

- Скорость
- Нет трафика между бд и сервисом
- Безопасность (не светим данными)
- Процедуры жестко связаны со структурой данных - соотв. меньше ошибок

#### Выполнение кода без определения функции или процедуры (так можно только в pg после 11 версии):

```sql
DO $$ BEGIN
    /*тут будет код*/ 
END $$;
```

```sql
DO $$ 
DECLARE 
    /*тут будут объявлены переменны*/ 
BEGIN 
    /*тут будет код*/ 
END $$;
```

- Некоторые сведения
    - Можно перехватывать ошибки (`EXCEPTION WHEN OTHERS THEN`). Есть разные виды EXCEPTION-ов
    - Можно писать на SQL, или других языках, например Питон или даже JS, но нужны расширения и так же учитывать время
      на ретрансляцию кода.
    - Можно указать параметры создания, такие как режимы аргумента, права пользователя и другие (смотреть синтаксис
      создания в доке).

#### Функции и процедуры

Синтаксис:

```sql
CREATE OR REPLACE FUNCTION имя_функции()
RETURNS тип_результата AS
$$
DECLARE
    -- объявление переменных
BEGIN
    -- тело функции
    -- ваши SQL-запросы и логика
END;
$$
LANGUAGE plpgsql;
```

- Некоторые сведения
    - Можно вернуть результат структурой таблицы: `...RETURNS SETOF <table_name> AS...`
    - Можно создавать внутри процедуры новые таблицы и заполнять их (есть спец синтаксис для этого)
    - Через синтаксис execute `sql-запрос` можно выполнять запросы внутри процедуры (можно и без execute)
    - В процедурах есть можно делать транзакции
    - Есть перехват ошибок
    - Так же можно указать параметры создания (смотреть синтаксис создания ф-ции в доке)
    - Есть вызов функций из функций
    - Может принимать переменные
    - Есть разница между `return` (фактический возврат значения) и `returns` (стоит после объявления аргументов и
      указывает, какой тип будет возвращен).

- Виды передачи параметров:
    - Позиционная (важен порядок)
    - Именная (важно имя параметра)
    - Смешанная (именные не могут стоять перед позиционными)

#### Курсор

-- остановился на 1.13.57