## Хранимые процедуры и Тригеры

[К оглавлению...](/README.md)

Плюсы хранимых процедур (по сути бизнес логики в базе)

- Скорость
- Нет трафика между бд и сервисом
- Безопасность (не светим данными)
- Процедуры жестко связаны со структурой данных - соотв. меньше ошибок

#### Выполнение кода без определения функции или процедуры (так можно только в pg после 11 версии):

```sql
DO $$ BEGIN
    /*тут будет код*/ 
END $$;
```

```sql
DO $$ 
DECLARE 
    /*тут будут объявлены переменны*/ 
BEGIN 
    /*тут будет код*/ 
END $$;
```

- Некоторые сведения
    - Можно перехватывать ошибки (`EXCEPTION WHEN OTHERS THEN`). Есть разные виды EXCEPTION-ов
    - Можно писать на SQL, или других языках, например Питон или даже JS, но нужны расширения и так же учитывать время
      на ретрансляцию кода.
    - Можно указать параметры создания, такие как режимы аргумента, права пользователя и другие (смотреть синтаксис
      создания в доке).

#### Функции и процедуры

Синтаксис:

```sql
CREATE OR REPLACE FUNCTION имя_функции()
RETURNS тип_результата AS
$$
DECLARE
    -- объявление переменных
BEGIN
    -- тело функции
    -- ваши SQL-запросы и логика
END;
$$
LANGUAGE plpgsql;
```

- Некоторые сведения
    - Можно вернуть результат структурой таблицы: `...RETURNS SETOF <table_name> AS...`
    - Можно создавать внутри процедуры новые таблицы и заполнять их (есть спец синтаксис для этого)
    - Через синтаксис execute `sql-запрос` можно выполнять запросы внутри процедуры (можно и без execute)
    - В процедурах есть можно делать транзакции
    - Есть перехват ошибок
    - Так же можно указать параметры создания (смотреть синтаксис создания ф-ции в доке)
    - Есть вызов функций из функций
    - Может принимать переменные
    - Есть разница между `return` (фактический возврат значения) и `returns` (стоит после объявления аргументов и
      указывает, какой тип будет возвращен).

- Виды передачи параметров:
    - Позиционная (важен порядок)
    - Именная (важно имя параметра)
    - Смешанная (именные не могут стоять перед позиционными)

#### Курсор

Курсор нужен для перебора данных

```sql
-- Без транзакции курсоры не работают
BEGIN;
-- Открыть курсор для выполнения запроса
DECLARE my_cursor CURSOR FOR SELECT saga_id, step FROM sagas;
-- Прочитать данные из курсора
FETCH NEXT FROM my_cursor;
-- Закрыть курсор
CLOSE my_cursor;

COMMIT;
```

#### Тригеры

Триггеры в PostgreSQL - это специальные хранимые процедуры, которые автоматически выполняются при определенных
событиях в базе данных, таких как вставка (INSERT), обновление (UPDATE) или удаление (DELETE) записей из таблицы.

```sql
CREATE TRIGGER имя_триггера
AFTER INSERT OR UPDATE OR DELETE ON имя_таблицы
FOR EACH ROW
WHEN (условие)
EXECUTE FUNCTION имя_функции();
```

- Типы триггеров
    - BEFORE
    - AFTER
    - INSTEAD OF ("вместо" - позволяют перехватывать вставку (INSERT), обновление (UPDATE), удаление (DELETE)
      и предоставляют возможность заменить стандартное действие базы данных на пользовательские действия)

- Переменны для работы с триггерами (используются для временного хранения значений и обмена данными внутри триггера)
    - `OLD` и `NEW`: Это псевдопеременные, которые содержат старые (для операции UPDATE) и новые (для операций INSERT и
      UPDATE) значения полей записи, на которой срабатывает триггер
    - `TG_OP`: Эта переменная содержит информацию об операции, которая вызвала триггер
    - `TG_TABLE_NAME`: то переменная, которая содержит имя таблицы, на которой сработал триггер
    - Пользовательские переменные
    - И другие...

#### Временные таблицы

Для хранимых процедур можно использовать временные таблицы. Когда-то это может быть удобно